# Report System Improvements - Implementation Plan

## Overview
Implementing UI improvements, bug fixes, and report history feature for both Owner and Coach portals.

## Changes Required

### 1. UI Improvements ✅ COMPLETED
- [x] Remove "Generated By" from report preview
- [x] Keep only: Report Type, Filter, Generated On
- [x] Replace PDF icon button with "Download PDF" text button
- [x] Remove "Download Full PDF" button
- [x] Applied to both Owner and Coach screens

### 2. Fix Batch-Wise Report Download Error
**Problem:** NaN error when generating PDF for specific batches
**Root Cause:** Chart data or numeric values contain NaN when filtering by specific batch

**Solution:**
- Add NaN sanitization in _buildPdfContent before chart generation
- Ensure all numeric values are validated before PDF rendering
- Add proper null/empty checks for batch-specific data

**Files to modify:**
- `reports_screen.dart` (Owner)
- `coach_reports_screen.dart` (Coach)

### 3. Report History Feature
**Requirements:**
- Save generated reports per user (owner/coach separately)
- Display list of previously generated reports
- Allow re-downloading from history
- Reports should NOT be shared between owner and coach

**Implementation Approach:**

#### Backend Changes:
1. Create new database table: `report_history`
   ```sql
   - id (primary key)
   - user_id (foreign key)
   - user_type (owner/coach)
   - report_type (attendance/fee/performance)
   - filter_type (season/year/month)
   - filter_value
   - batch_id (nullable)
   - file_name
   - generated_at (timestamp)
   - report_data (JSON - store the generated report data)
   ```

2. Create API endpoints:
   - POST `/api/reports/history` - Save report to history
   - GET `/api/reports/history/{user_id}?user_type={type}` - Get user's report history
   - GET `/api/reports/history/{id}/download` - Re-download a report from history
   - DELETE `/api/reports/history/{id}` - Delete a report from history

#### Frontend Changes:
1. Create `ReportHistoryService` to handle API calls
2. Add "Report History" tab/section in reports screen
3. Display list of reports with:
   - Report type icon
   - Filter details (Season/Year/Month + Batch)
   - Generated date/time
   - Download button
   - Delete button (optional)

4. Save report to history after successful generation
5. Implement re-download functionality

**Files to create/modify:**
- Backend: `main.py` (add endpoints and database model)
- Frontend: 
  - `lib/core/services/report_history_service.dart` (new)
  - `lib/models/report_history.dart` (new)
  - `lib/screens/owner/reports_screen.dart` (modify)
  - `lib/screens/coach/coach_reports_screen.dart` (modify)

## Implementation Order
1. ✅ UI Improvements (DONE)
2. Fix batch-wise download error
3. Backend: Database schema and API endpoints
4. Frontend: Report history service and UI
5. Testing and validation

## Notes
- Report history should be user-specific (owner vs coach)
- PDF files can be regenerated from stored report_data
- Consider adding pagination if history grows large
- Add option to clear old reports (e.g., older than 6 months)

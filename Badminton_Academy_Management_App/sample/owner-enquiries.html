<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enquiry Management - Owner</title>
    <link rel="stylesheet" href="owner-styles.css">
</head>
<body>
    <div class="container">
        <div class="nav">
            <a href="owner-dashboard.html" >üìä Dashboard</a>
            <a href="owner.html" >üë®‚Äçüè´ Coaches</a>
            <a href="owner-batches.html" >üìö Batches</a>
            <a href="owner-students.html" >üéì Students</a>
            <a href="owner-attendance.html" >üìã Attendance</a>
            <a href="owner-coach-attendance.html" >üëî Coach Attendance</a>
            <a href="owner-fees.html" >üí∞ Fees</a>
            <a href="owner-performance.html" >‚≠ê Performance</a>
            <a href="owner-bmi.html" >üìè BMI</a>
            <a href="owner-schedule.html" >üìÖ Schedule</a>
            <a href="owner-enquiries.html" class="active">üìû Enquiries</a>
            <a href="owner-analytics.html" >üìà Analytics</a>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>

        <div class="header">
            <h1>üìû Enquiry Management</h1>
            <button class="btn btn-primary" onclick="openModal()">+ Add Enquiry</button>
        </div>

        <div class="enquiry-grid" id="enquiriesList"></div>
    </div>

    <div id="enquiryModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2 style="color: #667eea; margin-bottom: 20px;">Add Enquiry</h2>
            <form id="enquiryForm">
                <div class="form-group">
                    <label>Name *</label>
                    <input type="text" id="name" required>
                </div>
                <div class="form-group">
                    <label>Phone *</label>
                    <input type="tel" id="phone" required>
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="email">
                </div>
                <div class="form-group">
                    <label>Message *</label>
                    <textarea id="message" required></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Add Enquiry</button>
            </form>
        </div>
    </div>

    <div id="updateModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeUpdateModal()">&times;</span>
            <h2 style="color: #667eea; margin-bottom: 20px;">Update Enquiry</h2>
            <form id="updateForm">
                <input type="hidden" id="updateEnquiryId">
                <div class="form-group">
                    <label>Status *</label>
                    <select id="updateStatus" required>
                        <option value="New">New</option>
                        <option value="Contacted">Contacted</option>
                        <option value="Converted">Converted</option>
                        <option value="Closed">Closed</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Followed Up By</label>
                    <input type="text" id="followedUpBy" placeholder="Your name">
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="notes" placeholder="Add follow-up notes..."></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Update Enquiry</button>
            </form>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8000';

        loadEnquiries();

        function openModal() {
            document.getElementById('enquiryModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('enquiryModal').style.display = 'none';
            document.getElementById('enquiryForm').reset();
        }

        function openUpdateModal(enquiry) {
            document.getElementById('updateEnquiryId').value = enquiry.id;
            document.getElementById('updateStatus').value = enquiry.status;
            document.getElementById('followedUpBy').value = enquiry.followed_up_by || '';
            document.getElementById('notes').value = enquiry.notes || '';
            document.getElementById('updateModal').style.display = 'block';
        }

        function closeUpdateModal() {
            document.getElementById('updateModal').style.display = 'none';
        }

        async function loadEnquiries() {
            try {
                const response = await fetch(`${API_URL}/enquiries/`);
                const enquiries = await response.json();

                const container = document.getElementById('enquiriesList');
                
                if (enquiries.length === 0) {
                    container.innerHTML = '<div style="text-align: center; color: #999; padding: 60px;">No enquiries yet</div>';
                    return;
                }

                container.innerHTML = enquiries.reverse().map(enq => `
                    <div class="enquiry-card">
                        <div class="enquiry-header">${enq.name}</div>
                        <div class="enquiry-info">
                            <div>üìû ${enq.phone}</div>
                            <div>üìß ${enq.email || 'N/A'}</div>
                            <div style="margin-top: 10px;"><strong>Message:</strong> ${enq.message}</div>
                            <div style="margin-top: 10px;">
                                <span class="status-badge status-${enq.status.toLowerCase()}">${enq.status}</span>
                            </div>
                            ${enq.followed_up_by ? `<div style="margin-top: 10px;"><strong>Followed up by:</strong> ${enq.followed_up_by}</div>` : ''}
                            ${enq.notes ? `<div style="margin-top: 10px;"><strong>Notes:</strong> ${enq.notes}</div>` : ''}
                            <div style="margin-top: 10px; font-size: 12px; color: #999;">Created: ${formatDateTime(enq.created_at)}</div>
                        </div>
                        <div class="action-buttons">
                            <button class="btn btn-primary btn-small" onclick='openUpdateModal(${JSON.stringify(enq)})'>Update</button>
                            <button class="btn btn-primary btn-small" onclick="deleteEnquiry(${enq.id})" style="background: #dc3545;">Delete</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading enquiries:', error);
            }
        }

        document.getElementById('enquiryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const enquiryData = {
                name: document.getElementById('name').value,
                phone: document.getElementById('phone').value,
                email: document.getElementById('email').value || null,
                message: document.getElementById('message').value,
                status: 'New'
            };

            try {
                const response = await fetch(`${API_URL}/enquiries/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(enquiryData)
                });

                if (response.ok) {
                    alert('Enquiry added!');
                    closeModal();
                    loadEnquiries();
                } else {
                    alert('Failed to add enquiry');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        });

        document.getElementById('updateForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const id = document.getElementById('updateEnquiryId').value;
            const updateData = {
                status: document.getElementById('updateStatus').value,
                followed_up_by: document.getElementById('followedUpBy').value || null,
                notes: document.getElementById('notes').value || null
            };

            try {
                const response = await fetch(`${API_URL}/enquiries/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateData)
                });

                if (response.ok) {
                    alert('Enquiry updated!');
                    closeUpdateModal();
                    loadEnquiries();
                } else {
                    alert('Failed to update enquiry');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        });

        async function deleteEnquiry(id) {
            if (!confirm('Are you sure you want to delete this enquiry?')) return;

            try {
                const response = await fetch(`${API_URL}/enquiries/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert('Enquiry deleted!');
                    loadEnquiries();
                } else {
                    alert('Failed to delete enquiry');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        function formatDateTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        }

        setInterval(loadEnquiries, 30000);
    </script>
</body>
</html>
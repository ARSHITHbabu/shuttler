<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BMI Tracker - Student</title>
    <link rel="stylesheet" href="student-styles.css">
</head>
<body>
    <div class="container">
        <div class="nav">
            <a href="student-dashboard.html">ğŸ“Š Dashboard</a>
            <a href="student-invitations.html">ğŸ“¨ Invitations</a>
            <a href="student-batches.html">ğŸ“š Batches</a>
            <a href="student-attendance.html">ğŸ“‹ Attendance</a>
            <a href="student-fees.html">ğŸ’° Fees</a>
            <a href="student-performance.html">â­ Performance</a>
            <a href="student-bmi.html" class="active">ğŸ“ BMI</a>
            <a href="student-schedule.html">ğŸ“… Schedule</a>
            <a href="student-tournaments.html">ğŸ† Tournaments</a>
            <a href="student-videos.html">ğŸ¥ Videos</a>
            <a href="student-profile.html">ğŸ‘¤ Profile</a>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
        
        <h1>ğŸ“ BMI Tracker</h1>
        
        <div id="currentBmiContainer"></div>
        
        <div id="dataContainer"></div>
    </div>

    <script>
        const API_URL = 'http://localhost:8000';
        let currentStudent = null;

        const loggedInStudent = sessionStorage.getItem('loggedInStudent');
        if (!loggedInStudent) {
            window.location.href = 'student.html';
        } else {
            currentStudent = JSON.parse(loggedInStudent);
            loadData();
        }

        function getBMICategory(bmi) {
            if (bmi < 18.5) return { text: 'Underweight', class: 'underweight' };
            if (bmi < 25) return { text: 'Normal Weight', class: 'normal' };
            if (bmi < 30) return { text: 'Overweight', class: 'overweight' };
            return { text: 'Obese', class: 'obese' };
        }

        async function loadData() {
            try {
                const response = await fetch(`${API_URL}/bmi/student/${currentStudent.id}`);
                const bmiRecords = await response.json();
                
                const currentContainer = document.getElementById('currentBmiContainer');
                const dataContainer = document.getElementById('dataContainer');
                
                if (bmiRecords.length === 0) {
                    dataContainer.innerHTML = '<div class="empty-state">ğŸ“ No BMI records yet</div>';
                    currentContainer.innerHTML = '';
                    return;
                }

                // Get latest BMI
                const latestBmi = bmiRecords[0];
                const category = getBMICategory(latestBmi.bmi);

                currentContainer.innerHTML = `
                    <div class="current-bmi">
                        <h2>ğŸ“ Current BMI Status</h2>
                        <div class="bmi-value">${latestBmi.bmi}</div>
                        <div class="bmi-category">${category.text}</div>
                        <p style="margin-top: 15px; font-size: 14px; opacity: 0.9;">
                            Height: ${latestBmi.height} cm | Weight: ${latestBmi.weight} kg
                        </p>
                        <p style="margin-top: 5px; font-size: 12px; opacity: 0.8;">
                            Last updated: ${formatDate(latestBmi.date)}
                        </p>
                    </div>
                `;

                dataContainer.innerHTML = `
                    <h3 style="margin-bottom: 15px; color: #333;">ğŸ“Š BMI History</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Height (cm)</th>
                                <th>Weight (kg)</th>
                                <th>BMI</th>
                                <th>Category</th>
                                <th>Recorded By</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${bmiRecords.map(record => {
                                const cat = getBMICategory(record.bmi);
                                return `
                                    <tr>
                                        <td><strong>${formatDate(record.date)}</strong></td>
                                        <td>${record.height} cm</td>
                                        <td>${record.weight} kg</td>
                                        <td><strong>${record.bmi}</strong></td>
                                        <td>
                                            <span class="bmi-badge bmi-${cat.class}">
                                                ${cat.text}
                                            </span>
                                        </td>
                                        <td>${record.recorded_by || 'N/A'}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('dataContainer').innerHTML = '<div class="empty-state">âš ï¸ Error loading BMI data</div>';
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        function logout() {
            sessionStorage.removeItem('loggedInStudent');
            window.location.href = 'student.html';
        }

        setInterval(loadData, 30000);
    </script>
</body>
</html>

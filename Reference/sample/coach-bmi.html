<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BMI Calculator - Coach Portal</title>
    <link rel="stylesheet" href="coach-styles.css">
</head>
<body>
    <!-- Navigation Bar -->
    <div class="nav">
        <a href="coach-dashboard.html">üìä Dashboard</a>
        <a href="coach-batches.html">üìö Batches</a>
        <a href="coach-attendance.html">üìã Attendance</a>
        <a href="coach-fees.html">üí∞ Fees</a>
        <a href="coach-performance.html">‚≠ê Performance</a>
        <a href="coach-bmi.html" class="active">üìè BMI</a>
        <a href="coach-schedule.html">üìÖ Schedule</a>
        <a href="coach-invite.html">‚úâÔ∏è Invite</a>
        <a href="coach-enquiries.html">üìû Enquiries</a>
        <a href="coach-students.html">üéì Students</a>
        <button class="logout-btn" onclick="logout()">Logout</button>
    </div>

    <!-- Main Container -->
    <div class="main-content">
        <h1>üìè BMI Calculator</h1>
        
        <div class="form-card">
            <h2>Calculate & Record BMI</h2>
            <form id="bmiForm">
                <div class="form-group">
                    <label>Select Your Batch</label>
                    <select id="batchSelect" required>
                        <option value="">-- Select Batch --</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Select Student</label>
                    <select id="studentSelect" required>
                        <option value="">-- Select Student --</option>
                    </select>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Height (cm)</label>
                        <input type="number" id="height" step="0.1" required placeholder="e.g., 170">
                    </div>
                    
                    <div class="form-group">
                        <label>Weight (kg)</label>
                        <input type="number" id="weight" step="0.1" required placeholder="e.g., 65">
                    </div>
                </div>
                
                <button type="submit">Calculate & Save BMI</button>
            </form>
            
            <div id="bmiResult"></div>
        </div>

        <h2>Recent BMI Records</h2>
        <div id="bmiRecords"></div>
    </div>

    <script>
        const API_URL = 'http://localhost:8000';
        let currentCoach = null;

        const loggedInCoach = sessionStorage.getItem('loggedInCoach');
        if (!loggedInCoach) {
            window.location.href = 'coach.html';
        } else {
            currentCoach = JSON.parse(loggedInCoach);
            loadBatches();
            loadBMIRecords();
        }

        async function loadBatches() {
            try {
                const response = await fetch(`${API_URL}/batches/coach/${currentCoach.id}`);
                const batches = await response.json();
                
                const select = document.getElementById('batchSelect');
                batches.forEach(batch => {
                    const option = document.createElement('option');
                    option.value = batch.id;
                    option.textContent = batch.batch_name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading batches:', error);
            }
        }

        document.getElementById('batchSelect').addEventListener('change', async (e) => {
            const batchId = e.target.value;
            const studentSelect = document.getElementById('studentSelect');
            studentSelect.innerHTML = '<option value="">-- Select Student --</option>';

            if (batchId) {
                try {
                    const response = await fetch(`${API_URL}/batch-students/${batchId}`);
                    const students = await response.json();
                    
                    students.forEach(student => {
                        const option = document.createElement('option');
                        option.value = student.id;
                        option.textContent = student.name;
                        studentSelect.appendChild(option);
                    });
                } catch (error) {
                    console.error('Error loading students:', error);
                }
            }
        });

        document.getElementById('bmiForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const height = parseFloat(document.getElementById('height').value);
            const weight = parseFloat(document.getElementById('weight').value);
            const studentId = parseInt(document.getElementById('studentSelect').value);

            const bmiData = {
                student_id: studentId,
                height: height,
                weight: weight,
                date: new Date().toISOString().split('T')[0],
                recorded_by: `Coach: ${currentCoach.name}`
            };

            try {
                const response = await fetch(`${API_URL}/bmi/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(bmiData)
                });

                if (response.ok) {
                    const result = await response.json();
                    displayBMIResult(result.bmi);
                    setTimeout(() => {
                        alert('BMI recorded successfully!');
                        document.getElementById('bmiForm').reset();
                        loadBMIRecords();
                    }, 2000);
                } else {
                    alert('Failed to record BMI');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        });

        function displayBMIResult(bmi) {
            let category = '';
            let color = '';
            
            if (bmi < 18.5) {
                category = 'Underweight';
                color = 'linear-gradient(135deg, #3b82f6, #2563eb)';
            } else if (bmi < 25) {
                category = 'Normal';
                color = 'linear-gradient(135deg, #10b981, #059669)';
            } else if (bmi < 30) {
                category = 'Overweight';
                color = 'linear-gradient(135deg, #f59e0b, #d97706)';
            } else {
                category = 'Obese';
                color = 'linear-gradient(135deg, #ef4444, #dc2626)';
            }

            document.getElementById('bmiResult').innerHTML = `
                <div class="bmi-result" style="background: ${color};">
                    <div style="font-size: 1.2rem;">Calculated BMI</div>
                    <div class="bmi-value">${bmi}</div>
                    <div style="font-size: 1.5rem; font-weight: bold;">${category}</div>
                </div>
            `;
        }

        async function loadBMIRecords() {
            try {
                const batchesRes = await fetch(`${API_URL}/batches/coach/${currentCoach.id}`);
                const batches = await batchesRes.json();
                
                let allRecords = [];
                for (const batch of batches) {
                    const studentsRes = await fetch(`${API_URL}/batch-students/${batch.id}`);
                    const students = await studentsRes.json();
                    
                    for (const student of students) {
                        const bmiRes = await fetch(`${API_URL}/bmi/student/${student.id}`);
                        const records = await bmiRes.json();
                        allRecords.push(...records.map(r => ({...r, studentName: student.name})));
                    }
                }

                const container = document.getElementById('bmiRecords');
                
                if (allRecords.length === 0) {
                    container.innerHTML = '<div class="empty-state">No BMI records yet</div>';
                    return;
                }

                allRecords.sort((a, b) => new Date(b.date) - new Date(a.date));

                container.innerHTML = '<table><thead><tr><th>Date</th><th>Student</th><th>Height (cm)</th><th>Weight (kg)</th><th>BMI</th><th>Category</th></tr></thead><tbody>' +
                allRecords.slice(0, 20).map(record => {
                    let category = '';
                    let categoryClass = '';
                    if (record.bmi < 18.5) {
                        category = 'Underweight';
                        categoryClass = 'cat-underweight';
                    } else if (record.bmi < 25) {
                        category = 'Normal';
                        categoryClass = 'cat-normal';
                    } else if (record.bmi < 30) {
                        category = 'Overweight';
                        categoryClass = 'cat-overweight';
                    } else {
                        category = 'Obese';
                        categoryClass = 'cat-obese';
                    }
                    
                    return `
                        <tr>
                            <td>${formatDate(record.date)}</td>
                            <td><strong>${record.studentName}</strong></td>
                            <td>${record.height}</td>
                            <td>${record.weight}</td>
                            <td><strong>${record.bmi}</strong></td>
                            <td><span class="category-badge ${categoryClass}">${category}</span></td>
                        </tr>
                    `;
                }).join('') + '</tbody></table>';
            } catch (error) {
                console.error('Error loading BMI records:', error);
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        function logout() {
            sessionStorage.removeItem('loggedInCoach');
            window.location.href = 'coach.html';
        }
    </script>
</body>
</html>
